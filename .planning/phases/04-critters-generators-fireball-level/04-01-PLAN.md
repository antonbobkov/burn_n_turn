# Phase 4 — Wave 1: Road, FireballBonusAnimation, Slime/Sliminess

---
wave: 1
depends_on: ["03-game-entities-and-animations"]
files_modified:
  - code/game/controller/level_controller.h
  - code/game/controller/level_controller.cc
  - code/game/level.h
  - code/game/level.cc
  - code/game/critters.h
  - code/game/critters.cc
  - code/game/fireball.h
  - code/game/fireball.cc
autonomous: true
---

**Phase:** 4 — Critters, generators, fireball, level  
**Goal (ROADMAP):** Migrate types that own leaf entities. CONTEXT: EntityListController only owns entities not referred elsewhere; use GetNonOwned* for entities owned by LevelController/Dragon.

**This plan:** Migrate Road, FireballBonusAnimation, Slime, Sliminess to single owner (LevelController); FireballBonusAnimation uses lsBonus only + GetNonOwned*; centralize CleanUp(lsBonus) in LevelController.

## must_haves (goal-backward verification)

- [ ] LevelController::vRd is std::vector<std::unique_ptr<Road>> (or FancyRoad); roads not in lsDraw with ownership — add to GetNonOwnedDrawEntities (and update if needed). Init creates roads with make_unique and stores in vRd; AddV no longer takes ownership (or remove AddV for roads and only expose via GetNonOwned*).
- [ ] LevelController::lsBonus is std::list<std::unique_ptr<FireballBonusAnimation>>; FireballBonusAnimation not in lsDraw/lsUpdate. LevelController::GetNonOwnedDrawEntities and GetNonOwnedUpdateEntities include pointers from lsBonus. LevelController::Update() calls CleanUp(lsBonus) once at start (or defined place) so dead animations are removed. Critters create bonus animations by returning or passing unique_ptr to level (level pushes into lsBonus); no AddBoth(pFb) + lsBonus.push_back(pFb) — single registration.
- [ ] LevelController::lsSlimes and lsSliminess are std::list<std::unique_ptr<Slime>> and std::list<std::unique_ptr<Sliminess>>; they are not in base lsUpdate/lsDraw. Expose via GetNonOwnedUpdateEntities/GetNonOwnedDrawEntities. CleanUp(lsSlimes), CleanUp(lsSliminess) remain in LevelController::Update.
- [ ] SP_Info removed from Road, FireballBonusAnimation, Slime, Sliminess where no smart_pointer remains (CLEAN-01).
- [ ] Build succeeds; ctest and simulation_test pass (VER-01, VER-02).

---

## Task 1 — Road (vRd) unique_ptr; GetNonOwned*

1. In `level_controller.h`: Change `std::vector<smart_pointer<Road>> vRd` to `std::vector<std::unique_ptr<Road>> vRd` (or use FancyRoad if that is what is created). Remove smart_pointer include if no longer needed here.
2. In `level_controller.cc` Init: Create roads with `std::make_unique<FancyRoad>(...)` (or Road); push_back(std::move(...)) into vRd. Do not call AddV with ownership — instead expose roads for drawing via GetNonOwnedDrawEntities (append raw pointers from vRd to the returned vector). If roads are draw-only and not in lsUpdate, only GetNonOwnedDrawEntities needs them.
3. Update any code that iterates vRd to use .get() or raw pointers. Build and ctest; simulation_test.

---

## Task 2 — FireballBonusAnimation: lsBonus only; GetNonOwned*; centralize CleanUp

1. In `level_controller.h`: Change `std::list<smart_pointer<FireballBonusAnimation>> lsBonus` to `std::list<std::unique_ptr<FireballBonusAnimation>> lsBonus`.
2. In `level_controller.cc`: At start of LevelController::Update(), call CleanUp(lsBonus) once (adapt CleanUp for unique_ptr list: erase elements where !(*itr)->bExist). Ensure GetNonOwnedDrawEntities and GetNonOwnedUpdateEntities include pointers from lsBonus (iterate lsBonus, push_back(itr->get())).
3. In `critters.cc` (and any other creator of FireballBonusAnimation): Create with std::make_unique<FireballBonusAnimation>(...). Pass the unique_ptr to LevelController (e.g. add method AddBonusAnimation(std::unique_ptr<FireballBonusAnimation> p) that lsBonus.push_back(std::move(p))). Do not call pAc->AddBoth(pFb); do not push smart_pointer into lsBonus — single registration in lsBonus.
4. In `dragon.cc` and `critters.cc`: Remove all CleanUp(pAd->lsBonus) and iteration over lsBonus that assumed shared refs; Dragon and Knight only set bExist = false on hit (they receive FireballBonusAnimation* from level or from iteration that level provides). If Dragon/Knight need to iterate bonuses for hit detection, they get the list of pointers from LevelController (e.g. GetNonOwned* or a getter that returns vector<FireballBonusAnimation*>). Update Dragon::Update() and Knight::Update() to use that; after setting bExist = false, LevelController’s CleanUp(lsBonus) will remove them next frame.
5. In `fireball.h` / `fireball.cc`: Remove SP_Info from FireballBonusAnimation if no smart_pointer remains. Build and ctest; simulation_test.

---

## Task 3 — Slime and Sliminess: unique_ptr in LevelController; GetNonOwned*

1. In `level_controller.h`: Change `std::list<smart_pointer<Slime>> lsSlimes` to `std::list<std::unique_ptr<Slime>> lsSlimes` and `std::list<smart_pointer<Sliminess>> lsSliminess` to `std::list<std::unique_ptr<Sliminess>> lsSliminess`.
2. In `level_controller.cc` Init and anywhere Slime/Sliminess are created: Use make_unique and push_back(std::move(...)) into lsSlimes or lsSliminess. Do not add them to lsUpdate/lsDraw with ownership. Override GetNonOwnedUpdateEntities and GetNonOwnedDrawEntities to include pointers from lsSlimes and lsSliminess (so base Update runs them).
3. In `critters.cc`: Where Sliminess or Slime are created and added (e.g. pAdv->AddBoth(pSlm)), change to a level method that takes unique_ptr and stores in lsSlimes/lsSliminess (e.g. AddSlime(std::unique_ptr<Slime>), AddSliminess(std::unique_ptr<Sliminess>)). LevelController already has AddE in some places — remove those and use the new owned lists + GetNonOwned*.
4. CleanUp(lsSlimes) and CleanUp(lsSliminess) stay in LevelController::Update(); adapt for unique_ptr list if needed (erase where !bExist).
5. Remove SP_Info from Slime, Sliminess if no smart_pointer remains. Build and ctest; simulation_test.

---

## Verification

- Build: `cmake ../code -G "MinGW Makefiles"; mingw32-make` (or project build).
- Tests: `ctest --output-on-failure`; run simulation_test.
- Grep for smart_pointer<Road>, smart_pointer<FireballBonusAnimation>, smart_pointer<Slime>, smart_pointer<Sliminess> in level_controller and critters — should be none.

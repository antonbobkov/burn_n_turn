---
phase: 04-critters-generators-fireball-level
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - code/game/controller/level_controller.h
  - code/game/controller/level_controller.cc
  - code/game/critters.cc
autonomous: true

must_haves:
  truths:
    - "Level-owned Road instances are drawn via GetNonOwnedDrawEntities"
    - "FireballBonusAnimation is owned only in lsBonus; CleanUp(lsBonus) runs in LevelController::Update only"
    - "Slime and Sliminess are owned in LevelController and exposed via GetNonOwned*"
  artifacts:
    - path: code/game/controller/level_controller.h
      provides: vRd, lsBonus, lsSlimes, lsSliminess as unique_ptr containers
    - path: code/game/controller/level_controller.cc
      provides: GetNonOwned* including roads, bonuses, slimes; CleanUp(lsBonus) in Update
  key_links:
    - from: level_controller.cc
      to: GetNonOwnedDrawEntities
      via: vRd raw ptrs appended
      pattern: "vRd.*\\.get\\(\\)|push_back.*vRd"
    - from: level_controller.cc
      to: GetNonOwnedUpdateEntities/GetNonOwnedDrawEntities
      via: lsBonus, lsSlimes, lsSliminess raw ptrs appended
---

<objective>
Migrate level-owned Road, FireballBonusAnimation, Slime, and Sliminess from
smart_pointer to unique_ptr in LevelController. Single owner at LevelController;
all exposure via GetNonOwnedUpdateEntities / GetNonOwnedDrawEntities. CleanUp
for lsBonus centralized in LevelController::Update (remove from dragon.cc and
critters.cc). Preserve behavior; VER-01/02.

Purpose: Bottom-up Phase 4; clear ownership for level-owned leaf-like entities.
Output: vRd, lsBonus, lsSlimes, lsSliminess as unique_ptr; GetNonOwned* wired;
CLEAN-01 where applicable.
</objective>

<execution_context>
@~/.cursor/get-shit-done/workflows/execute-plan.md
@~/.cursor/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-critters-generators-fireball-level/04-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate Road (vRd) to unique_ptr</name>
  <files>code/game/controller/level_controller.h, code/game/controller/level_controller.cc, code/game/level.cc</files>
  <action>
    In level_controller.h: change
    std::vector&lt;smart_pointer&lt;Road&gt;&gt; vRd
    to std::vector&lt;std::unique_ptr&lt;Road&gt;&gt; vRd.
    In level_controller.cc Init: where vRd is filled (e.g. make_smart(new FancyRoad(...))), use std::make_unique&lt;FancyRoad&gt;(...) and vRd.push_back(std::move(...)). Remove any AddV(vRd[i]) for roads; instead append vRd[i].get() in GetNonOwnedDrawEntities. In level.cc if vRd is constructed, use make_unique and push_back(move). Do not add roads to lsDraw; they are only exposed via GetNonOwnedDrawEntities. Remove SP_Info from Road if no smart_pointer&lt;Road&gt; remains (CLEAN-01).
  </action>
  <verify>cd build; mingw32-make; cd ../bin; .\simulation_test.exe</verify>
  <done>vRd is vector of unique_ptr; roads drawn via GetNonOwnedDrawEntities; build and simulation_test pass.</done>
</task>

<task type="auto">
  <name>Task 2: Migrate FireballBonusAnimation (lsBonus) and centralize CleanUp</name>
  <files>code/game/controller/level_controller.h, code/game/controller/level_controller.cc, code/game/critters.cc, code/game/dragon.cc</files>
  <action>
    In level_controller.h: change std::list&lt;smart_pointer&lt;FireballBonusAnimation&gt;&gt; lsBonus to std::list&lt;std::unique_ptr&lt;FireballBonusAnimation&gt;&gt; lsBonus. In level_controller.cc: add CleanUp(lsBonus) in Update() (e.g. after CleanUp(lsSlimes)/CleanUp(lsSliminess)); in GetNonOwnedUpdateEntities and GetNonOwnedDrawEntities append raw ptrs from lsBonus (for (auto& p : lsBonus) out.push_back(p.get())). In critters.cc where FireballBonusAnimation is created: use std::make_unique, then pAc->lsBonus.push_back(std::move(pFb)); do NOT call pAc->AddBoth(pFb). Add LevelController method if needed (e.g. AddBonusAnimation(std::unique_ptr&lt;FireballBonusAnimation&gt;)) that push_back(move) into lsBonus. Remove all CleanUp(pAd->lsBonus) and CleanUp(pAc->lsBonus) from dragon.cc and critters.cc so only LevelController::Update calls CleanUp(lsBonus). Remove SP_Info from FireballBonusAnimation if no smart_pointer remains.
  </action>
  <verify>cd build; mingw32-make; cd ../bin; .\simulation_test.exe</verify>
  <done>lsBonus is list of unique_ptr; CleanUp(lsBonus) only in LevelController::Update; bonuses in GetNonOwned*; no AddBoth for new bonuses; build and tests pass.</done>
</task>

<task type="auto">
  <name>Task 3: Migrate Slime and Sliminess (lsSlimes, lsSliminess)</name>
  <files>code/game/controller/level_controller.h, code/game/controller/level_controller.cc, code/game/critters.cc</files>
  <action>
    In level_controller.h: change std::list&lt;smart_pointer&lt;Slime&gt;&gt; lsSlimes to std::list&lt;std::unique_ptr&lt;Slime&gt;&gt; lsSlimes and std::list&lt;smart_pointer&lt;Sliminess&gt;&gt; lsSliminess to std::list&lt;std::unique_ptr&lt;Sliminess&gt;&gt; lsSliminess. In level_controller.cc: in GetNonOwnedUpdateEntities and GetNonOwnedDrawEntities append raw ptrs from lsSlimes and lsSliminess. Update all push_back sites (critters.cc, level_controller.cc) to use make_unique and push_back(std::move(...)). CleanUp(lsSlimes) and CleanUp(lsSliminess) already in LevelController::Update; ensure they work with unique_ptr list (CleanUp template in entities.h must support list of unique_ptr; if it expects bExist on *itr, unique_ptr dereference is fine). Remove SP_Info from Slime and Sliminess if no smart_pointer remains.
  </action>
  <verify>cd build; mingw32-make; cd ../bin; .\simulation_test.exe</verify>
  <done>lsSlimes and lsSliminess are list of unique_ptr; exposed via GetNonOwned*; build and simulation_test pass.</done>
</task>

</tasks>

<verification>
Run from workspace root: cd build; mingw32-make; ctest --output-on-failure. Run bin/simulation_test.exe. Confirm no smart_pointer for Road, FireballBonusAnimation, Slime, Sliminess in level_controller.h.
</verification>

<success_criteria>
- vRd, lsBonus, lsSlimes, lsSliminess are unique_ptr containers in LevelController.
- GetNonOwnedUpdateEntities and GetNonOwnedDrawEntities include their raw ptrs.
- CleanUp(lsBonus) only in LevelController::Update.
- Build and all tests pass.
</success_criteria>

<output>
After completion, create .planning/phases/04-critters-generators-fireball-level/04-critters-generators-fireball-level-01-SUMMARY.md
</output>

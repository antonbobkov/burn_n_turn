---
phase: 04-critters-generators-fireball-level
plan: 06
type: execute
wave: 6
depends_on: ["04-05"]
files_modified:
  - code/game/controller/basic_controllers.h
  - code/game/controller/basic_controllers.cc
  - code/game/controller/level_controller.cc
  - code/game/critters.cc
  - code/game/critter_generators.cc
autonomous: true

must_haves:
  truths:
    - "ConsumableEntity/critters in lsPpl have a single owner; no double ownership with level/generators"
    - "Critters spawned by generators or level are exposed via GetNonOwned* or owned in one list"
  artifacts:
    - path: code/game/controller/basic_controllers.h
      provides: lsPpl as unique_ptr container or ownership clarified
  key_links:
    - from: GetNonOwnedUpdateEntities/GetNonOwnedDrawEntities
      to: critter raw ptrs
      via: level-owned or controller-owned list
---

<objective>
Clarify ownership for ConsumableEntity and critters (Princess, Knight, Mage,
Trader, Slime, etc.) currently in lsPpl or added via AddBoth. Per CONTEXT:
EntityListController only owns entities not referred to elsewhere; level-owned
and generator-spawned critters are referred to by level/generators, so either
(1) LevelController owns a list of critters and generators push into it
(unique_ptr), exposed via GetNonOwned*, or (2) lsPpl becomes the single owner
and creation sites pass unique_ptr. Migrate lsPpl to unique_ptr at owner;
expose via GetNonOwned* where needed. Record any skipped types for DOC-01.

Purpose: Single owner for critters; no double ownership; CLEAN-01 where applicable.
Output: lsPpl migrated or ownership documented; build and tests pass; skipped recorded.
</objective>

<execution_context>
@~/.cursor/get-shit-done/workflows/execute-plan.md
@~/.cursor/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-critters-generators-fireball-level/04-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Decide lsPpl ownership and migrate to unique_ptr at owner</name>
  <files>code/game/controller/basic_controllers.h, code/game/controller/basic_controllers.cc, code/game/controller/level_controller.cc</files>
  <action>
    Per RESEARCH: critters spawned by generators are "referred elsewhere" (generators); EntityListController should not double-own. Option A: LevelController owns a list (e.g. list&lt;unique_ptr&lt;ConsumableEntity&gt;&gt; or similar) and generator/level code pushes with move; GetNonOwned* includes those ptrs; lsPpl then holds only controller-only entities or is removed. Option B: Keep lsPpl but as list of raw ptrs; single owner elsewhere (e.g. LevelController critter list). Choose the option that matches existing GetNonOwned* pattern: LevelController already exposes vCs, vDr, generators, lsBonus, etc.; add a level-owned "critters" or "people" list if needed and have generators push unique_ptr there, expose via GetNonOwned*; do not AddBoth those critters. If lsPpl currently holds smart_pointer&lt;ConsumableEntity&gt;, migrate to unique_ptr (EntityListController or LevelController owns); update AddBoth(unique_ptr) or AddCritter(move) at creation sites (critter_generators.cc, critters.cc). Ensure CleanUp order: owned list cleaned before raw ptrs in GetNonOwned*.
  </action>
  <verify>cd build; mingw32-make; cd ../bin; .\simulation_test.exe</verify>
  <done>Single owner for critters in lsPpl or level list; no double ownership; GetNonOwned* or lsPpl consistent.</done>
</task>

<task type="auto">
  <name>Task 2: Update creation sites and CLEAN-01; record skipped</name>
  <files>code/game/critters.cc, code/game/critter_generators.cc, code/game/controller/level_controller.cc</files>
  <action>
    At every site that creates a critter (Princess, Knight, Mage, Trader, Slime, MegaSlime, etc.) and calls AddBoth(pCr) or AddE(pCr): use std::make_unique and either (1) push to LevelController-owned list and expose via GetNonOwned*, or (2) AddOwnedBoth(std::move(pCr)) / AddE(unique_ptr) so controller owns. Do not AddBoth(smart_pointer) for level-referred critters. Remove SP_Info from ConsumableEntity and critter types where no smart_pointer remains. If any type cannot be migrated (lifetime unclear), record it in .planning/smart_pointer_unmigrated.md or phase summary for DOC-01.
  </action>
  <verify>cd build; mingw32-make; cd ../bin; .\simulation_test.exe</verify>
  <done>Creation sites use unique_ptr and single owner; CLEAN-01 applied; skipped types recorded; build and tests pass.</done>
</task>

</tasks>

<verification>
Build and ctest; simulation_test.exe. No double ownership: entities referred to by level/generators not also in lsUpdate/lsDraw as owned copies. Grep for smart_pointer&lt;ConsumableEntity&gt; (expect none or documented).
</verification>

<success_criteria>
- Critters have single owner; lsPpl or level list uses unique_ptr; exposed via GetNonOwned*.
- Creation sites use make_unique and single handoff; no AddBoth(smart_pointer) for level-owned.
- Build and all tests pass; skipped types recorded.
</success_criteria>

<output>
After completion, create .planning/phases/04-critters-generators-fireball-level/04-critters-generators-fireball-level-06-SUMMARY.md
</output>

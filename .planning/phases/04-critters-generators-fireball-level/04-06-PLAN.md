# Phase 4 — Wave 6: Critters and lsPpl single owner; CLEAN-01; record skipped

---
wave: 6
depends_on: ["04-05"]
files_modified:
  - code/game/controller/basic_controllers.h
  - code/game/controller/basic_controllers.cc
  - code/game/controller/level_controller.h
  - code/game/controller/level_controller.cc
  - code/game/critters.h
  - code/game/critters.cc
  - code/game/critter_generators.cc
  - code/game/entities.h
  - code/game/fireball.h
  - code/game/fireball.cc
  - .planning/smart_pointer_unmigrated.md
autonomous: true
---

**Phase:** 4 — Critters, generators, fireball, level  
**Goal:** Complete Phase 4 ownership: critters and consumables (lsPpl) have single owner where possible; SP_Info removed (CLEAN-01); any type that could not be migrated recorded for DOC-01.

**This plan:** Ensure lsPpl and remaining critter/critter-spawned entities follow single-owner rule; remove SP_Info from all migrated types; update .planning/smart_pointer_unmigrated.md (or equivalent) for any skipped types.

## must_haves (goal-backward verification)

- [ ] EntityListController::lsUpdate, lsDraw, lsPpl: any entity that is also owned elsewhere (e.g. by LevelController, Dragon) is not in these lists with ownership — only entities with no other reference are owned here. Remaining smart_pointer in lsPpl/lsUpdate/lsDraw only for types not yet migrated or intentionally shared (document).
- [ ] All Phase 4 types that were migrated have SP_Info removed (CLEAN-01): Road, FireballBonusAnimation, Slime, Sliminess, Fireball, TimedFireballBonus, Dragon, Castle (no smart_pointer), generators. Grep SP_Info in game/ and game/controller/ — only unmigrated types or Phase 5+ types keep it.
- [ ] Any class that could not be migrated (lifetime unclear) is recorded in .planning/smart_pointer_unmigrated.md with rationale (per DOC-01).
- [ ] Build succeeds; ctest and simulation_test pass (VER-01, VER-02).
- [ ] Phase 4 success criteria met: critter, generator, fireball, level types with clear lifetime migrated; SP_Info removed where applicable; build and tests pass; skipped types recorded.

---

## Task 1 — lsPpl and critter-owned entities: single owner

1. Audit lsPpl (ConsumableEntity list): Who creates princesses, traders, etc.? LevelController and generators add them via AddE. Per CONTEXT, if an entity is owned elsewhere, it should not be in base lsUpdate with ownership. If consumables (Princess, Trader, etc.) are created by generators and “given” to the level, LevelController should own them (e.g. list of unique_ptr<ConsumableEntity>) and expose via GetNonOwnedUpdateEntities/GetNonOwnedDrawEntities; then remove from lsPpl. If lsPpl remains the single owner for some consumables (no other reference), keep them in lsPpl but migrate to unique_ptr in a single owning container if possible. Document: lsPpl or level-owned list; ensure no duplicate ownership.
2. Apply same rule to any remaining smart_pointer in LevelController or Dragon: either migrate to unique_ptr at single owner and raw pointers elsewhere, or record as skipped with rationale.
3. Build and ctest; simulation_test.

---

## Task 2 — CLEAN-01: Remove SP_Info from migrated types

1. In `fireball.h`, `critters.h`, `critter_generators.h`, `level.h`, and any other Phase 4 header: For each type that no longer uses smart_pointer<T> anywhere in the codebase, remove `virtual public SP_Info` (or `public SP_Info`) from the class definition. Types to check: FireballBonus, Fireball, TimedFireballBonus, CircularFireball, FireballBonusAnimation; Road, FancyRoad; Slime, Sliminess; Dragon; Castle; KnightGenerator, PrincessGenerator, TraderGenerator, MageGenerator, SkellyGenerator; and any critter type that no longer holds smart_pointer.
2. Remove #include "utils/smart_pointer.h" from files that no longer use smart_pointer (if possible without breaking other includes).
3. Build and ctest; simulation_test.

---

## Task 3 — Record skipped types (DOC-01)

1. In `.planning/smart_pointer_unmigrated.md` (or the file referenced in DOC-01): Add a section for Phase 4. List every class that still uses smart_pointer after Phase 4 with a brief rationale (e.g. "lifetime shared across X and Y; deferred to Phase 5"). If all Phase 4 types were migrated, state "All Phase 4 types migrated; no skipped types."
2. Ensure Phase 4 success criteria are documented as met (or list remaining work).

---

## Verification

- Build and ctest; simulation_test.
- Grep for SP_Info in code/game and code/game/controller — only in types that still use smart_pointer (documented).
- Phase 4 complete: critters, generators, fireball, level-owned structures migrated; SP_Info removed where applicable; skipped types recorded.

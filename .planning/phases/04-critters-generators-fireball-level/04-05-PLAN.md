---
phase: 04-critters-generators-fireball-level
plan: 05
type: execute
wave: 5
depends_on: ["04-04"]
files_modified:
  - code/game/controller/level_controller.h
  - code/game/controller/level_controller.cc
  - code/game/critter_generators.h
  - code/game/critters.cc
autonomous: true

must_haves:
  truths:
    - "LevelController owns Knight, Princess, Trader, Mage generators as unique_ptr; pGr and pMgGen are raw pointers"
    - "Generators are updated via GetNonOwnedUpdateEntities; no AddE(gen)"
    - "SkellyGenerator has a single owner (controller or level)"
  artifacts:
    - path: code/game/controller/level_controller.h
      provides: unique_ptr members for each level generator type; pGr, pMgGen as raw ptrs
  key_links:
    - from: level_controller.cc GetNonOwnedUpdateEntities
      to: generator raw ptrs
      via: pGr, pMgGen, and other generator .get()
---

<objective>
Migrate level generators (KnightGenerator, PrincessGenerator, TraderGenerator,
MageGenerator) to unique_ptr owned by LevelController. pGr and pMgGen remain
raw pointers. Do not AddE(gen); include generator .get() in
GetNonOwnedUpdateEntities (and draw if needed). SkellyGenerator: ensure single
owner (AddE with unique_ptr in SummonSkeletons or equivalent).

Purpose: Generators owned at LevelController; exposed via GetNonOwned* per CONTEXT.
Output: Generators as unique_ptr in LevelController; GetNonOwned* wired; build and tests pass.
</objective>

<execution_context>
@~/.cursor/get-shit-done/workflows/execute-plan.md
@~/.cursor/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-critters-generators-fireball-level/04-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: LevelController owns level generators; remove AddE(gen)</name>
  <files>code/game/controller/level_controller.h, code/game/controller/level_controller.cc</files>
  <action>
    In level_controller.h: add members for generator ownership, e.g. std::unique_ptr&lt;KnightGenerator&gt; pKnightGen, std::unique_ptr&lt;PrincessGenerator&gt; pPrincessGen, std::unique_ptr&lt;TraderGenerator&gt; pTraderGen, std::unique_ptr&lt;MageGenerator&gt; pMageGen (or a vector of unique_ptr if preferred). Keep KnightGenerator* pGr and MageGenerator* pMgGen as raw pointers. In level_controller.cc Init: where make_smart(new KnightGenerator(...)) and AddE(pGen) occur, use std::make_unique&lt;KnightGenerator&gt;(...) and store in pKnightGen; set pGr = pKnightGen.get(); do NOT call AddE(pGen). Same for Princess, Trader, Mage (pMgGen = pMageGen.get()). In GetNonOwnedUpdateEntities append pGr, pMgGen, and the other two generators' .get(). In GetNonOwnedDrawEntities add generator raw ptrs if they are drawn. Remove SP_Info from generator types if no smart_pointer remains.
  </action>
  <verify>cd build; mingw32-make; cd ../bin; .\simulation_test.exe</verify>
  <done>LevelController owns four generators as unique_ptr; pGr/pMgGen raw; GetNonOwned* include them; no AddE(gen).</done>
</task>

<task type="auto">
  <name>Task 2: SkellyGenerator single owner</name>
  <files>code/game/critters.cc, code/game/controller/basic_controllers.cc</files>
  <action>
    In critters.cc SummonSkeletons: where SkellyGenerator is created with make_smart and pAc-&gt;AddE(pSkel), use std::make_unique&lt;SkellyGenerator&gt;(...) and pass to AddE. EntityListController::AddE currently takes smart_pointer&lt;EventEntity&gt;; add an overload or change to accept std::unique_ptr&lt;EventEntity&gt; (move into lsUpdate or into owned_event_entities and expose via GetNonOwned*). RESEARCH: "SkellyGenerator can stay AddE (controller owns for lifetime)". So: ensure AddE can take unique_ptr (e.g. AddE(std::unique_ptr&lt;EventEntity&gt; p) that moves into owned list and appends to owned_event_entities for GetNonOwned*), and SummonSkeletons calls AddE(std::move(pSkel)). If the codebase already has AddOwnedEventEntity, use that and add SkellyGenerator to GetNonOwnedUpdateEntities from owned list. Single owner = controller's owned list; no double ownership.
  </action>
  <verify>cd build; mingw32-make; cd ../bin; .\simulation_test.exe</verify>
  <done>SkellyGenerator has single owner; AddE(unique_ptr) or AddOwned* used; build and tests pass.</done>
</task>

</tasks>

<verification>
Build and ctest; simulation_test.exe. Confirm no AddE(smart_pointer&lt;Generator&gt;) for level generators; GetNonOwnedUpdateEntities includes all four generator ptrs.
</verification>

<success_criteria>
- LevelController owns Knight/Princess/Trader/Mage generators; pGr, pMgGen raw.
- GetNonOwned* include generator ptrs; no AddE for level generators.
- SkellyGenerator single-owner; build and all tests pass.
</success_criteria>

<output>
After completion, create .planning/phases/04-critters-generators-fireball-level/04-critters-generators-fireball-level-05-SUMMARY.md
</output>

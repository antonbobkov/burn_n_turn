# Phase 4 — Wave 5: Generators owned by LevelController; GetNonOwned*

---
wave: 5
depends_on: ["04-04"]
files_modified:
  - code/game/controller/level_controller.h
  - code/game/controller/level_controller.cc
  - code/game/critter_generators.h
  - code/game/critter_generators.cc
  - code/game/critters.cc
autonomous: true
---

**Phase:** 4 — Critters, generators, fireball, level  
**CONTEXT:** LevelController owns generators (e.g. std::vector<std::unique_ptr<EventEntity>> or one unique_ptr per type). Do not put them in EntityListController::lsUpdate. LevelController exposes them via GetNonOwnedUpdateEntities (and GetNonOwnedDrawEntities if drawn). pGr and pMgGen remain non-owning raw pointers.

**This plan:** Migrate KnightGenerator, PrincessGenerator, TraderGenerator, MageGenerator to LevelController-owned unique_ptr; remove AddE(pGen) etc.; add pointers to GetNonOwnedUpdateEntities. SkellyGenerator: single owner (level or entity that creates it).

## must_haves (goal-backward verification)

- [ ] LevelController owns all four generators (Knight, Princess, Trader, Mage) in a container, e.g. std::vector<std::unique_ptr<EventEntity>> or four std::unique_ptr<...> members. Init creates them with std::make_unique and stores; does not call AddE(pGen). pGr and pMgGen are raw pointers to the Knight and Mage generator (e.g. pGr = generators[0].get() or pKnightGen.get()).
- [ ] LevelController::GetNonOwnedUpdateEntities includes the generator pointers so the base Update loop calls Update() on them. If generators are drawable, include in GetNonOwnedDrawEntities.
- [ ] SkellyGenerator is owned in one place (e.g. created in critters and added to level-owned list, or level holds it). No duplicate ownership.
- [ ] SP_Info removed from generator types where no smart_pointer remains (CLEAN-01).
- [ ] Build succeeds; ctest and simulation_test pass (VER-01, VER-02).

---

## Task 1 — LevelController: own generators; no AddE; GetNonOwned*

1. In `level_controller.h`: Add owning storage for generators, e.g. `std::unique_ptr<KnightGenerator> pKnightGen;` and same for Princess, Trader, Mage (or `std::vector<std::unique_ptr<EventEntity>> generators`). Keep `KnightGenerator* pGr;` and `MageGenerator* pMgGen;` (non-owning).
2. In `level_controller.cc` Init: Create each generator with std::make_unique<KnightGenerator>(...), etc. Store in the unique_ptr members (or push_back into vector). Set pGr = pKnightGen.get(); pMgGen = pMGen.get(). Remove AddE(pGen), AddE(pPGen), AddE(pTGen), AddE(pMGen).
3. In LevelController::GetNonOwnedUpdateEntities: append pKnightGen.get(), pPGen.get(), pTGen.get(), pMGen.get() (or iterate the vector and push_back .get()). So base EntityListController::Update will call Update() on them. If they are also drawn, add to GetNonOwnedDrawEntities.
4. Update any other code that assumed generators were in lsUpdate (e.g. CleanUp(lsUpdate) will no longer contain them; that is correct). Build and ctest; simulation_test.

---

## Task 2 — SkellyGenerator single owner

1. In `critters.cc` (or where SkellyGenerator is created): Currently make_smart(new SkellyGenerator(...)) and pAc->AddE(pSkel). Change to: level owns it. Either LevelController has a container for “spawned” generators (e.g. list of unique_ptr<EventEntity>) and a method AddGenerator(std::unique_ptr<EventEntity>), or the creating entity (e.g. a critter) owns it and registers with level via GetNonOwned* pattern. Per CONTEXT, EntityListController only owns entities not referred elsewhere — so LevelController should own SkellyGenerator. Add a LevelController method to add a generator (e.g. AddSpawnedGenerator(std::unique_ptr<EventEntity>)) and store in a list; expose in GetNonOwnedUpdateEntities.
2. In critters.cc: Create SkellyGenerator with std::make_unique; call pAc->AddSpawnedGenerator(std::move(pSkel)) (or equivalent). Remove AddE(pSkel).
3. Remove SP_Info from SkellyGenerator and other generator types if no smart_pointer remains. Build and ctest; simulation_test.

---

## Verification

- Build and ctest; simulation_test.
- Grep for AddE(pGen), AddE(pPGen), AddE(pTGen), AddE(pMGen), AddE(pSkel) — removed or replaced. Generators only in LevelController-owned storage and GetNonOwned*.

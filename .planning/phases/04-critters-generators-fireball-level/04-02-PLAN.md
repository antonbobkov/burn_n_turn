---
phase: 04-critters-generators-fireball-level
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - code/game/controller/level_controller.h
  - code/game/controller/level_controller.cc
  - code/game/dragon.h
  - code/game/dragon.cc
  - code/game/fireball.h
  - code/game/fireball.cc
autonomous: true

must_haves:
  truths:
    - "All fireballs (Fireball, ChainExplosion, KnightOnFire) are owned by Level; Dragon does not own a fireball list"
    - "Fireballs are updated and drawn via GetNonOwned*"
  artifacts:
    - path: code/game/controller/level_controller.h
      provides: Fireball container and AddFireball (or equivalent) taking unique_ptr
    - path: code/game/dragon.h
      provides: no lsBalls member
  key_links:
    - from: dragon.cc Dragon::Fire()
      to: LevelController
      via: AddFireball(std::move(pFb)) or equivalent
      pattern: "AddFireball|Add.*Fireball"
    - from: level_controller.cc
      to: GetNonOwnedUpdateEntities/GetNonOwnedDrawEntities
      via: fireball list raw ptrs
---

<objective>
Move all fireball ownership to LevelController. Add a Level-owned fireball list
(e.g. list of unique_ptr of base type for Fireball/ChainExplosion/KnightOnFire);
Dragon::lsBalls removed entirely. Dragon::Fire() and fireball.cc create with
make_unique and hand ownership to LevelController; expose via GetNonOwned*.
CleanUp fireball list in LevelController::Update.

Purpose: Single owner for fireballs at level; delete Dragon::lsBalls per CONTEXT.
Output: Level-owned fireball list; no lsBalls; build and tests pass.
</objective>

<execution_context>
@~/.cursor/get-shit-done/workflows/execute-plan.md
@~/.cursor/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-critters-generators-fireball-level/04-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add LevelController fireball list and AddFireball; wire GetNonOwned* and CleanUp</name>
  <files>code/game/controller/level_controller.h, code/game/controller/level_controller.cc</files>
  <action>
    In level_controller.h: add a container for level-owned fireballs. Use a single list that can hold Fireball and subclasses (e.g. std::list&lt;std::unique_ptr&lt;Fireball&gt;&gt; if ChainExplosion/KnightOnFire inherit Fireball, or a common base). Add method void AddFireball(std::unique_ptr&lt;Fireball&gt; p) (or template/overload for subclasses) that push_back(std::move(p)). In GetNonOwnedUpdateEntities and GetNonOwnedDrawEntities append raw ptrs from this list. In LevelController::Update add CleanUp for the fireball list (remove !bExist) before or with other CleanUps. Ensure CleanUp order: fireball list cleaned so no raw ptr outlives owner.
  </action>
  <verify>cd build; mingw32-make; cd ../bin; .\simulation_test.exe</verify>
  <done>LevelController owns a fireball list; AddFireball exists; GetNonOwned* and CleanUp include fireballs.</done>
</task>

<task type="auto">
  <name>Task 2: Dragon and fireball.cc create with make_unique and give to Level; remove lsBalls</name>
  <files>code/game/dragon.h, code/game/dragon.cc, code/game/fireball.cc</files>
  <action>
    In dragon.h: remove member std::list&lt;smart_pointer&lt;Fireball&gt;&gt; lsBalls. In dragon.cc: remove CleanUp(lsBalls). In Dragon::Fire() where a fireball is created (middle shot): create with std::make_unique&lt;Fireball&gt;(...) (or CircularFireball as appropriate); call pAd->AddFireball(std::move(pFb)) instead of AddBoth(pFb) and lsBalls.push_back(pFb). In fireball.cc: wherever Fireball, ChainExplosion, or KnightOnFire is created and pBc->AddBoth(pFb) is used (pBc is LevelController* in level context), create with make_unique and call LevelController method to take ownership (e.g. pBc->AddFireball(std::move(pFb)) or AddChainExplosion/AddKnightOnFire if separate methods). Remove all lsBalls references. Remove SP_Info from Fireball (and related) if no smart_pointer remains.
  </action>
  <verify>cd build; mingw32-make; cd ../bin; .\simulation_test.exe</verify>
  <done>Dragon has no lsBalls; all fireball creation uses make_unique and LevelController takes ownership; build and tests pass.</done>
</task>

</tasks>

<verification>
Run build and ctest; run simulation_test.exe. Grep for lsBalls in codebase (expect zero). Confirm GetNonOwned* includes fireball list.
</verification>

<success_criteria>
- LevelController owns all fireballs; AddFireball (or equivalent) used from Dragon and fireball.cc.
- Dragon::lsBalls removed; no references to lsBalls.
- Build and all tests pass.
</success_criteria>

<output>
After completion, create .planning/phases/04-critters-generators-fireball-level/04-critters-generators-fireball-level-02-SUMMARY.md
</output>

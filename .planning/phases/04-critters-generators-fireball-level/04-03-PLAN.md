---
phase: 04-critters-generators-fireball-level
plan: 03
type: execute
wave: 3
depends_on: ["04-02"]
files_modified:
  - code/game/dragon.h
  - code/game/dragon.cc
  - code/game/controller/level_controller.cc
  - code/game/controller/dragon_game_controller.h
  - code/game/controller/dragon_game_controller.cc
autonomous: true

must_haves:
  truths:
    - "Dragon owns lsBonuses as list of unique_ptr; TimedFireballBonus exposed via GetNonOwned*"
    - "Carry-over: first Update runs RecoverBonuses then ClearBonusesToCarryOver; Dragon ctor does not clear carry-over"
  artifacts:
    - path: code/game/dragon.h
      provides: lsBonuses as list of unique_ptr; AddBonus takes unique_ptr or rvalue
  key_links:
    - from: level_controller.cc Update (bFirstUpdate)
      to: RecoverBonuses then ClearBonusesToCarryOver
      via: order preserved
    - from: level_controller.cc GetNonOwnedUpdateEntities
      to: Dragon lsBonuses
      via: iterate vDr, then each dragon's lsBonuses .get()
---

<objective>
Migrate Dragon::lsBonuses to unique_ptr; fix carry-over handoff so
RecoverBonuses runs before ClearBonusesToCarryOver on first Update; remove
ClearBonusesToCarryOver from Dragon ctor. Expose TimedFireballBonus ptrs in
LevelController::GetNonOwnedUpdateEntities (and draw if needed). AddBonus
signature takes unique_ptr or move.

Purpose: Single owner for timed bonuses on Dragon; correct carry-over semantics.
Output: lsBonuses unique_ptr; carry-over fix; GetNonOwned* includes bonuses.
</objective>

<execution_context>
@~/.cursor/get-shit-done/workflows/execute-plan.md
@~/.cursor/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-critters-generators-fireball-level/04-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate lsBonuses to unique_ptr; AddBonus and RecoverBonuses use move</name>
  <files>code/game/dragon.h, code/game/dragon.cc, code/game/controller/level_controller.cc</files>
  <action>
    In dragon.h: change std::list&lt;smart_pointer&lt;TimedFireballBonus&gt;&gt; lsBonuses to std::list&lt;std::unique_ptr&lt;TimedFireballBonus&gt;&gt; lsBonuses. Change AddBonus to accept std::unique_ptr&lt;TimedFireballBonus&gt; or by-value move. In dragon.cc: update AddBonus to push_back(std::move(pBonus)); update RecoverBonuses to move from GetBonusesToCarryOver() into lsBonuses (handoff by move). Update GetBonus return type if it currently returns smart_pointer (return raw ptr or optional; call sites that add to carry-over or AddBonus must take ownership via make_unique from GetBonus data if needed). DragonGameController::AddBonusToCarryOver and GetBonusesToCarryOver: if they use smart_pointer, migrate to unique_ptr (carry-over list holds unique_ptr; AddBonusToCarryOver takes unique_ptr by move). In level_controller.cc BonusDrawer and GetNonOwned*: iterate vDr[nDr]-&gt;lsBonuses and use .get() for raw ptrs (update BonusList typedef to list of unique_ptr if local). Remove SP_Info from TimedFireballBonus if no smart_pointer remains.
  </action>
  <verify>cd build; mingw32-make; cd ../bin; .\simulation_test.exe</verify>
  <done>lsBonuses is list of unique_ptr; AddBonus and carry-over use move semantics.</done>
</task>

<task type="auto">
  <name>Task 2: Carry-over order fix and expose bonuses in GetNonOwned*</name>
  <files>code/game/dragon.cc, code/game/controller/level_controller.cc</files>
  <action>
    In Dragon ctor: remove the line that calls pAd-&gt;pGl-&gt;ClearBonusesToCarryOver() so the carry-over list is not cleared before first Update. In level_controller.cc Update (bFirstUpdate block): keep order as vDr[0]-&gt;RecoverBonuses() then pGl-&gt;ClearBonusesToCarryOver() so bonuses are recovered before clear. In GetNonOwnedUpdateEntities (and GetNonOwnedDrawEntities if bonuses are drawn from a single place): append raw ptrs from each dragon's lsBonuses (for each vDr[i], for each entry in vDr[i]-&gt;lsBonuses push_back .get()). Ensure BonusDrawer in level_controller.cc uses vDr[i]-&gt;lsBonuses with unique_ptr (it already iterates; change to const auto& or .get() as needed).
  </action>
  <verify>cd build; mingw32-make; cd ../bin; .\simulation_test.exe</verify>
  <done>RecoverBonuses then Clear on first Update; Dragon ctor does not clear; bonuses in GetNonOwned*; build and tests pass.</done>
</task>

</tasks>

<verification>
Build and ctest; simulation_test.exe. Confirm Dragon ctor has no ClearBonusesToCarryOver; confirm first-Update order RecoverBonuses then Clear.
</verification>

<success_criteria>
- lsBonuses is list of unique_ptr; carry-over handoff by move on first Update.
- Dragon ctor does not clear carry-over; LevelController first Update does RecoverBonuses then Clear.
- GetNonOwned* includes Dragon bonus ptrs; build and tests pass.
</success_criteria>

<output>
After completion, create .planning/phases/04-critters-generators-fireball-level/04-critters-generators-fireball-level-03-SUMMARY.md
</output>
